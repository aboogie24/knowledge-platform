name: Helm Chart - Build and Publish

on:
  push:
    branches: [main]
    paths:
      - 'charts/**'
      - '.github/workflows/helm.yaml'
    tags:
      - 'chart-v*'
  pull_request:
    branches: [main]
    paths:
      - 'charts/**'

env:
  CHART_NAME: knowledge-platform
  HARBOR_REGISTRY: harbor.justpurple.org
  HARBOR_PROJECT: knowledge-platform

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Add dependency repos
        run: |
          helm repo add meilisearch https://meilisearch.github.io/meilisearch-kubernetes

      - name: Lint chart
        run: |
          helm dependency update charts/${{ env.CHART_NAME }}
          helm lint charts/${{ env.CHART_NAME }}

      - name: Template chart
        run: |
          helm template test charts/${{ env.CHART_NAME }} \
            --set ingestionWorker.github.repo=test/repo \
            --debug

  package:
    needs: lint
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    outputs:
      chart_version: ${{ steps.chart_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Add dependency repos
        run: |
          helm repo add meilisearch https://meilisearch.github.io/meilisearch-kubernetes

      - name: Get chart version
        id: chart_version
        run: |
          VERSION=$(grep '^version:' charts/${{ env.CHART_NAME }}/Chart.yaml | awk '{print $2}')
          # Append git sha for non-tag builds
          if [[ ! "$GITHUB_REF" =~ ^refs/tags/ ]]; then
            VERSION="${VERSION}-${GITHUB_SHA::7}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $VERSION"

      - name: Update chart version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.chart_version.outputs.version }}/" charts/${{ env.CHART_NAME }}/Chart.yaml

      - name: Package chart
        run: |
          mkdir -p helm-packages
          helm dependency update charts/${{ env.CHART_NAME }}
          helm package charts/${{ env.CHART_NAME }} --destination helm-packages
          ls -la helm-packages

      - name: Upload chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: helm-packages/*.tgz

  publish-harbor:
    needs: package
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - name: Download chart artifact
        uses: actions/download-artifact@v4
        with:
          name: helm-chart
          path: helm-packages

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Login to Harbor
        run: |
          helm registry login ${{ env.HARBOR_REGISTRY }} \
            --username ${{ secrets.HARBOR_USERNAME }} \
            --password ${{ secrets.HARBOR_PASSWORD }}

      - name: Push to Harbor OCI registry
        run: |
          CHART_PACKAGE=$(ls helm-packages/*.tgz)
          helm push $CHART_PACKAGE oci://${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}

      - name: Logout from Harbor
        if: always()
        run: |
          helm registry logout ${{ env.HARBOR_REGISTRY }} || true

  publish-ghcr:
    needs: package
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    permissions:
      packages: write
    steps:
      - name: Download chart artifact
        uses: actions/download-artifact@v4
        with:
          name: helm-chart
          path: .helm-packages

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Login to GHCR
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ghcr.io \
            --username ${{ github.actor }} \
            --password-stdin

      - name: Push to GHCR
        run: |
          CHART_PACKAGE=$(ls helm-packages/*.tgz)
          helm push $CHART_PACKAGE oci://ghcr.io/${{ github.repository_owner }}/charts

      - name: Logout from GHCR
        if: always()
        run: |
          helm registry logout ghcr.io || true

  publish-pages:
    needs: package
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/chart-v')
    permissions:
      contents: write
      pages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Add dependency repos
        run: |
          helm repo add meilisearch https://meilisearch.github.io/meilisearch-kubernetes

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

  # Update Artifact Hub metadata
  update-artifacthub:
    needs: [publish-pages]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/chart-v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create/Update artifacthub-repo.yml
        run: |
          cat > artifacthub-repo.yml << 'EOF'
          repositoryID: ${{ secrets.ARTIFACTHUB_REPO_ID }}
          owners:
            - name: aboogie24
              email: ${{ secrets.ARTIFACTHUB_EMAIL }}
          EOF

      - name: Commit artifacthub-repo.yml
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add artifacthub-repo.yml
          git diff --staged --quiet || git commit -m "chore: update artifacthub metadata"
          git push
